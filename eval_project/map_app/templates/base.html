{% extends "easy_maps/map.html" %}


{% block html %}
<div id="map-canvas-{{ map.pk }}"
  {% if map.computed_address %}
    style="width: 100% !important; height: {{ height|default:"500" }}px;"
  {% endif %}
  class="easy-map-googlemap">
  {% block noscript %}{{ block.super }}{% endblock %}
  {% if not map.computed_address %}<!-- geocoding error -->{% endif %}
</div>
{% endblock %}

{% block api_js %}
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?
  key={{ api_key }}&libraries=places&callback=initialize_map_{{ map.pk }}" async defer></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
{% endblock %}

{% block map_loading_js %}
{% endblock %}

{% block extra_js %}
 	var service = new google.maps.places.PlacesService(map);
 	var infowindow = new google.maps.InfoWindow();
 	var geocoder = new google.maps.Geocoder();
	var marker = new google.maps.Marker({
		        position: latlng,
		        map: map,
		        title: "{{ map.address }}"
		    });
 	var getInfoContent = function(name, formatted_address){
 	    var nameStr = '', addressStr = '';
 	    if (typeof name !== 'undefined'){
 	    	nameStr = "<strong>" + name + "</strong><br>"
 	    }
 	    if (typeof formatted_address !== 'undefined'){
 	    	addressStr = "Address:" + formatted_address 
 		}
 		return "<div>" + nameStr + addressStr + "</div>"
    };

    var modifyMarker = function(results, latLng){
    	map.setZoom({{ zoom }});
	    map.panTo(latLng);
		marker.setPosition(latLng);
	    infowindow.setContent(getInfoContent(results[0].name, results[0].formatted_address))
	    infowindow.open(map, marker)
	}
    infowindow.setContent(getInfoContent('', "{{ map.address }}" ));
    infowindow.open(map, marker)
	var placeMarkerAndPanTo = function(e){
		var latLng = e.latLng;
		var latLngStr = [latLng.lat(), latLng.lng()].join(',');
		var on_land = true;
		geocoder.geocode({location: latLng}, 
			function(results, status){
			if(status === 'OK'){
			    $.getJSON('https://api.onwater.io/api/v1/results/' + latLngStr)
			    .done(function(data){
    			    on_land = !data.water;
    			    if (on_land){
    				    modifyMarker(results, latLng);
    				    $('#id__address').val(results[0].formatted_address)
    				    $('form').submit();
    				}else{
    					window.alert('Locations in woods/mountain/ocean are not valid.');
    			    }
				}).fail(function(err){
					console.error("Error occurred retrieving location on land status:", err)
				});
			}else{
				window.alert(`Geocode was not successful for the following reason: ${status}`)
			}
		})
    };
    google.maps.event.addDomListener(map, 'click', placeMarkerAndPanTo);
    marker.addListener('click', placeMarkerAndPanTo); 
{% endblock %}
